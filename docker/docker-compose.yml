---
version: '3.8'

services:
  db-test:
    image: postgres:14.5
    container_name: btw-postgres-line-provider-test
    ports:
      - "5440:5432"
    environment:
      POSTGRES_USER: betwise-test
      POSTGRES_PASSWORD: betwise-test
      POSTGRES_DB: betwise-test
    tty: true
    networks:
      - btw-dev-network
  db-local:
    image: postgres:14.5
    container_name: btw-postgres-line-provider
    ports:
      - "5441:5432"
    environment:
      POSTGRES_USER: betwise
      POSTGRES_PASSWORD: betwise
      POSTGRES_DB: betwise
    volumes:
      - pgdata_line_provide:/var/lib/postgresql/data
    tty: true
    networks:
      - btw-dev-network
  line-provider:
    container_name: btw-line-provider
    platform: linux/x86_64
    build:
      context: ../
      dockerfile: docker/Dockerfile.dev
    restart: always
    volumes:
      - ../src:/src
      - ../opt:/opt
    ports:
      - "8061:8000"
    environment:
      - API_ENVIRONMENT=local
    healthcheck:
      test: ["CMD", "curl", "-f", "localhost:8000/healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - btw-dev-network
    tty: true
    depends_on:
      - db-test
      - db-local
  line-provider-worker:
    container_name: btw-line-provider-worker
    platform: linux/x86_64
    build:
      context: ../
      dockerfile: docker/Dockerfile.dev
    command: [ "bash", "-c", "celery -A scheduler worker -l error -Q line_provider_queue --without-gossip --without-mingle" ]
    restart: always
    volumes:
      - ../src:/src
    environment:
      - API_ENVIRONMENT=local
    networks:
      - btw-dev-network
    tty: true
    depends_on:
      - db-test
      - db-local
  line-provider-worker-beat:
    container_name: btw-line-provider-worker-beat
    platform: linux/x86_64
    build:
      context: ../
      dockerfile: docker/Dockerfile.dev
    command: [ "bash", "-c", "celery -A scheduler beat -l info" ]
    restart: always
    volumes:
      - ../src:/src
    environment:
      - API_ENVIRONMENT=local
    networks:
      - btw-dev-network
    tty: true
    depends_on:
      - db-test
      - db-local
  redis:
    container_name: redis
    image: redis:6-alpine
    restart: always
    ports:
      - '6390:6379'
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    networks:
      - btw-dev-network
networks:
  btw-dev-network:
    external: true
volumes:
  pgdata_line_provide:
